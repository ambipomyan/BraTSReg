# BraTSReg
Prepared for MICCAI 2022 challenge

## problem located
- performance and tuning

## dependency
numpy  
nibabel  
cv2  
csv  

## parallelism related
CUDA 11.4  
Numba 0.50.1( llvmlite will be included when installing Numba )   
colorama 0.4.5( >=0.3.9 is fine )  

## sample run: case141
```
input dims(HWC): 240 240 155
sliced input dims(HWC): 240 240 155
saving images...
block radius(HWC): 3 3 3
init search window radius(HWC): 10 10 10
alpha: 1.0
----------------- Kid = 1 -----------------
throwing darts...
# of list points for mls: 12582
voxel dim by mm (HWC): 1 1 1
iter#: 0 F(Z): 8788.136552378535 f(z): 7154.436547461897 ||AX-Z||: 58564.0 ||Xk+1-Xk|| 58564 sw: 10
iter#: 1 F(Z): 8131.913831539452 f(z): 6628.165413364768 ||AX-Z||: 58555.47930334701 ||Xk+1-Xk|| 31108 sw: 10
iter#: 2 F(Z): 7506.1020002141595 f(z): 6241.271546602249 ||AX-Z||: 53689.09267454422 ||Xk+1-Xk|| 29027 sw: 10
iter#: 3 F(Z): 7032.157663092017 f(z): 5954.619663313031 ||AX-Z||: 48306.60487336394 ||Xk+1-Xk|| 24520 sw: 10
iter#: 4 F(Z): 6679.422814160585 f(z): 5742.306715104729 ||AX-Z||: 44105.20382219119 ||Xk+1-Xk|| 20337 sw: 10
iter#: 5 F(Z): 6392.56159761548 f(z): 5578.41666694358 ||AX-Z||: 40667.5581819665 ||Xk+1-Xk|| 16622 sw: 10
iter#: 6 F(Z): 6168.827769055963 f(z): 5456.411342371255 ||AX-Z||: 37986.780663916805 ||Xk+1-Xk|| 12999 sw: 10
iter#: 7 F(Z): 5995.845608904958 f(z): 5366.775127731264 ||AX-Z||: 35789.52210028224 ||Xk+1-Xk|| 10111 sw: 10
iter#: 8 F(Z): 5879.090227294713 f(z): 5320.967491324991 ||AX-Z||: 33859.70430421238 ||Xk+1-Xk|| 7147 sw: 10
iter#: 9 F(Z): 5816.1829573735595 f(z): 5301.051873747259 ||AX-Z||: 32603.333150384027 ||Xk+1-Xk|| 4970 sw: 10
iter#: 10 F(Z): 5787.43878666684 f(z): 5288.921800233424 ||AX-Z||: 32050.960735994988 ||Xk+1-Xk|| 3072 sw: 10
iter#: 11 F(Z): 5775.805067602545 f(z): 5284.988020204008 ||AX-Z||: 31737.926306430276 ||Xk+1-Xk|| 2070 sw: 10
iter#: 12 F(Z): 5769.799672167748 f(z): 5281.880452416837 ||AX-Z||: 31599.35802570338 ||Xk+1-Xk|| 1501 sw: 10
iter#: 13 F(Z): 5766.364570979029 f(z): 5280.396766774356 ||AX-Z||: 31522.69941258806 ||Xk+1-Xk|| 1125 sw: 10
iter#: 14 F(Z): 5764.179426111281 f(z): 5279.156182251871 ||AX-Z||: 31484.952745958566 ||Xk+1-Xk|| 888 sw: 10
iter#: 15 F(Z): 5762.906546771526 f(z): 5278.399962082505 ||AX-Z||: 31474.12003797571 ||Xk+1-Xk|| 598 sw: 10
iter#: 16 F(Z): 5762.096706904471 f(z): 5279.278689786792 ||AX-Z||: 31422.310106330955 ||Xk+1-Xk|| 427 sw: 10
iter#: 17 F(Z): 5761.7236656323075 f(z): 5279.107108898461 ||AX-Z||: 31411.942947879335 ||Xk+1-Xk|| 302 sw: 10
iter#: 18 F(Z): 5761.422024220228 f(z): 5278.218168459833 ||AX-Z||: 31429.744227380128 ||Xk+1-Xk|| 274 sw: 10
iter#: 19 F(Z): 5761.144436437637 f(z): 5277.655100610107 ||AX-Z||: 31440.41978527802 ||Xk+1-Xk|| 224 sw: 10
iter#: 0 F(Z): 6397.029271636158 f(z): 5832.34960847348 ||AX-Z||: 17506.338342294894 ||Xk+1-Xk|| 14868 sw: 5
iter#: 1 F(Z): 6412.332617878914 f(z): 5850.5234889015555 ||AX-Z||: 17460.223291021335 ||Xk+1-Xk|| 1051 sw: 5
iter#: 2 F(Z): 6410.926444750279 f(z): 5854.398236148059 ||AX-Z||: 17365.32691055496 ||Xk+1-Xk|| 229 sw: 5
iter#: 3 F(Z): 6410.558412771672 f(z): 5854.907289981842 ||AX-Z||: 17347.164911458858 ||Xk+1-Xk|| 65 sw: 5
iter#: 4 F(Z): 6410.448073480278 f(z): 5855.013497829437 ||AX-Z||: 17342.814818230843 ||Xk+1-Xk|| 13 sw: 5
iter#: 5 F(Z): 6410.452763393521 f(z): 5855.188478380442 ||AX-Z||: 17340.798166127126 ||Xk+1-Xk|| 3 sw: 5
iter#: 6 F(Z): 6410.469355069101 f(z): 5855.168965250254 ||AX-Z||: 17341.35572626835 ||Xk+1-Xk|| 3 sw: 5
iter#: 7 F(Z): 6410.486200992018 f(z): 5855.2948102504015 ||AX-Z||: 17338.846009618414 ||Xk+1-Xk|| 3 sw: 5
iter#: 8 F(Z): 6410.511219572276 f(z): 5855.302513316274 ||AX-Z||: 17339.12747145251 ||Xk+1-Xk|| 4 sw: 5
iter#: 9 F(Z): 6410.5322907269 f(z): 5855.318838253617 ||AX-Z||: 17339.139229112556 ||Xk+1-Xk|| 5 sw: 5
iter#: 10 F(Z): 6410.494959805161 f(z): 5855.318838253617 ||AX-Z||: 17338.741981170468 ||Xk+1-Xk|| 0 sw: 5
iter#: 0 F(Z): 7146.3419376164675 f(z): 6254.376913007349 ||AX-Z||: 9487.644947810704 ||Xk+1-Xk|| 4178 sw: 2
iter#: 1 F(Z): 7157.26976724714 f(z): 6289.800997581333 ||AX-Z||: 9236.97169086696 ||Xk+1-Xk|| 424 sw: 2
iter#: 2 F(Z): 7153.416899964213 f(z): 6293.965236436576 ||AX-Z||: 9177.40775885736 ||Xk+1-Xk|| 67 sw: 2
iter#: 3 F(Z): 7151.90907138586 f(z): 6295.639302488416 ||AX-Z||: 9157.272775171998 ||Xk+1-Xk|| 18 sw: 2
iter#: 4 F(Z): 7151.702196508646 f(z): 6295.788884054869 ||AX-Z||: 9153.766042542178 ||Xk+1-Xk|| 2 sw: 2
iter#: 5 F(Z): 7151.659547567368 f(z): 6295.849140327424 ||AX-Z||: 9153.09769208049 ||Xk+1-Xk|| 1 sw: 2
iter#: 6 F(Z): 7151.622262299061 f(z): 6295.849140327424 ||AX-Z||: 9152.722997377386 ||Xk+1-Xk|| 0 sw: 2
iter#: 0 F(Z): 7141.595012538135 f(z): 6295.849140327424 ||AX-Z||: 4552.008251115508 ||Xk+1-Xk|| 0 sw: 1
----------------- Kid = 2 -----------------
throwing darts...
# of list points for mls: 4745
voxel dim by mm (HWC): 1 1 1
iter#: 0 F(Z): 3569.5781172811985 f(z): 2965.488114248961 ||AX-Z||: 21491.0 ||Xk+1-Xk|| 21491 sw: 10
iter#: 1 F(Z): 3380.87745270133 f(z): 2766.6569236032665 ||AX-Z||: 22782.124949839257 ||Xk+1-Xk|| 12080 sw: 10
iter#: 2 F(Z): 3135.3089742846787 f(z): 2547.9227414615452 ||AX-Z||: 22454.6801720294 ||Xk+1-Xk|| 13502 sw: 10
iter#: 3 F(Z): 2867.2688728049397 f(z): 2365.0243270248175 ||AX-Z||: 20429.578264211814 ||Xk+1-Xk|| 12436 sw: 10
iter#: 4 F(Z): 2625.2541997656226 f(z): 2222.6411555483937 ||AX-Z||: 18032.288683021976 ||Xk+1-Xk|| 10622 sw: 10
iter#: 5 F(Z): 2423.770721644163 f(z): 2135.1978974677622 ||AX-Z||: 15337.648495489331 ||Xk+1-Xk|| 7578 sw: 10
iter#: 6 F(Z): 2323.4033398777246 f(z): 2114.591155525297 ||AX-Z||: 13023.62420560433 ||Xk+1-Xk|| 3931 sw: 10
iter#: 7 F(Z): 2301.363850913942 f(z): 2111.406411934644 ||AX-Z||: 12306.043723109577 ||Xk+1-Xk|| 1823 sw: 10
iter#: 8 F(Z): 2296.9961817637086 f(z): 2108.4906940199435 ||AX-Z||: 12229.284237711752 ||Xk+1-Xk|| 768 sw: 10
iter#: 9 F(Z): 2295.9865536615252 f(z): 2108.2913828901947 ||AX-Z||: 12192.359204928633 ||Xk+1-Xk|| 321 sw: 10
iter#: 10 F(Z): 2295.7617554292083 f(z): 2108.698632325977 ||AX-Z||: 12169.166551259757 ||Xk+1-Xk|| 139 sw: 10
iter#: 11 F(Z): 2295.696841068566 f(z): 2108.476995613426 ||AX-Z||: 12171.01045358467 ||Xk+1-Xk|| 82 sw: 10
iter#: 12 F(Z): 2295.6476312875748 f(z): 2108.9091650880873 ||AX-Z||: 12155.790690139096 ||Xk+1-Xk|| 43 sw: 10
iter#: 13 F(Z): 2295.642147116363 f(z): 2108.981934133917 ||AX-Z||: 12154.325956616764 ||Xk+1-Xk|| 12 sw: 10
iter#: 14 F(Z): 2295.6408409029245 f(z): 2108.9990355856717 ||AX-Z||: 12152.877769721688 ||Xk+1-Xk|| 5 sw: 10
iter#: 15 F(Z): 2295.64440138638 f(z): 2108.9990355856717 ||AX-Z||: 12152.963108533611 ||Xk+1-Xk|| 0 sw: 10
iter#: 0 F(Z): 2557.662868589163 f(z): 2325.1426317617297 ||AX-Z||: 6916.051680706583 ||Xk+1-Xk|| 5617 sw: 5
iter#: 1 F(Z): 2563.9438176825643 f(z): 2330.296658538282 ||AX-Z||: 6917.5532812199135 ||Xk+1-Xk|| 342 sw: 5
iter#: 2 F(Z): 2563.3944438174367 f(z): 2331.2668020799756 ||AX-Z||: 6885.308441849619 ||Xk+1-Xk|| 65 sw: 5
iter#: 3 F(Z): 2563.2505252584815 f(z): 2331.374502979219 ||AX-Z||: 6880.702535415269 ||Xk+1-Xk|| 15 sw: 5
iter#: 4 F(Z): 2563.1809645444155 f(z): 2331.3990980014205 ||AX-Z||: 6879.173595484724 ||Xk+1-Xk|| 4 sw: 5
iter#: 5 F(Z): 2563.161382012069 f(z): 2331.502287887037 ||AX-Z||: 6876.396274959663 ||Xk+1-Xk|| 3 sw: 5
iter#: 6 F(Z): 2563.1686957478523 f(z): 2331.6082129999995 ||AX-Z||: 6874.54663750867 ||Xk+1-Xk|| 3 sw: 5
iter#: 7 F(Z): 2563.1631270721555 f(z): 2331.6082129999995 ||AX-Z||: 6874.5997196843755 ||Xk+1-Xk|| 0 sw: 5
iter#: 0 F(Z): 2879.361579053104 f(z): 2513.034163981676 ||AX-Z||: 3730.7767980040867 ||Xk+1-Xk|| 1768 sw: 2
iter#: 1 F(Z): 2882.67947229743 f(z): 2532.263679921627 ||AX-Z||: 3606.115204025282 ||Xk+1-Xk|| 229 sw: 2
iter#: 2 F(Z): 2879.215990677476 f(z): 2533.199134811759 ||AX-Z||: 3570.5031946574722 ||Xk+1-Xk|| 41 sw: 2
iter#: 3 F(Z): 2877.7879791781306 f(z): 2533.563390955329 ||AX-Z||: 3558.825667194761 ||Xk+1-Xk|| 13 sw: 2
iter#: 4 F(Z): 2877.1839597150683 f(z): 2533.6660996228456 ||AX-Z||: 3554.026905539924 ||Xk+1-Xk|| 6 sw: 2
iter#: 5 F(Z): 2876.912246234715 f(z): 2533.6660996228456 ||AX-Z||: 3552.1624823268403 ||Xk+1-Xk|| 0 sw: 2
iter#: 0 F(Z): 2878.0376399308443 f(z): 2533.6660996228456 ||AX-Z||: 1777.8458125947413 ||Xk+1-Xk|| 0 sw: 1
```
## visualization(image slice in the middle, 240 x 240 x 1, mm)
#### inputs:
moving image:  
![moving image](https://github.com/ambipomyan/BraTSReg/blob/main/moving.jpg)  
fixed image:  
![fixed image](https://github.com/ambipomyan/BraTSReg/blob/main/fixed.jpg)  
#### itermediate result:
mask image:  
![mask image](https://github.com/ambipomyan/BraTSReg/blob/main/mask.jpg)  
#### result:
![pred image](https://github.com/ambipomyan/BraTSReg/blob/main/pred.jpg)  
